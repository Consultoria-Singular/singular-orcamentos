<main class="container layout-column">
  <app-toolbar
    title="Projetos"
    subtitle="Acompanhe os orcamentos e configure os detalhes de cada projeto"
    [breadcrumbs]="[{ label: 'Projetos' }]"
    [hasProjectedActions]="true"
    [showThemeToggle]="true">
    <div toolbar-actions>
      <ds-button variant="primary" (buttonClick)="onCreateProject()">
        Novo projeto
      </ds-button>
      <ds-button variant="ghost" (buttonClick)="reload()" [disabled]="loading">
        Recarregar
      </ds-button>
    </div>
  </app-toolbar>

  <section *ngIf="loading" class="loading-state">
    <span class="loading-spinner" aria-hidden="true"></span>
    <span>Carregando projetos...</span>
  </section>

  <section *ngIf="error && !loading" class="alert" role="alert">
    {{ error }}
    <div class="table-actions" style="margin-top: var(--space-2);">
      <ds-button variant="ghost" (buttonClick)="reload()">Tentar novamente</ds-button>
    </div>
  </section>

  <section *ngIf="!loading && !error && projects.length" class="table-wrapper" aria-live="polite">
    <table class="table">
      <thead>
        <tr>
          <th>Projeto</th>
          <th>Total</th>
          <th>Epicos</th>
          <th>Itens</th>
          <th class="col-actions">Acoes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let project of projects; trackBy: trackByProject">
          <td>
            <strong>{{ project.name }}</strong>
          </td>
          <td>{{ project.total | currencyFormat }}</td>
          <td>{{ project.epics.length }}</td>
          <td>{{ project.budgetItems.length }}</td>
          <td class="col-actions">
            <div class="actions-menu" (click)="$event.stopPropagation()">
              <button
                type="button"
                class="actions-menu__trigger btn btn--ghost btn--icon"
                (click)="toggleMenu(project.id, $event)"
                [attr.aria-expanded]="openMenuProjectId === project.id"
                aria-haspopup="menu"
                [attr.aria-label]="'Acoes do projeto ' + project.name">
                <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                  <circle cx="8" cy="3" r="1.5"></circle>
                  <circle cx="8" cy="8" r="1.5"></circle>
                  <circle cx="8" cy="13" r="1.5"></circle>
                </svg>
              </button>
              <ul
                *ngIf="openMenuProjectId === project.id"
                class="actions-menu__list"
                role="menu"
                [style.top.px]="menuPosition?.top"
                [style.left.px]="menuPosition?.left"
                (click)="$event.stopPropagation()">
                <li role="none">
                  <button class="actions-menu__item" type="button" role="menuitem" (click)="onViewItems(project.id)">Itens</button>
                </li>
                <li role="none">
                  <button class="actions-menu__item" type="button" role="menuitem" (click)="onViewSettings(project.id)">Configuracoes</button>
                </li>
                <li role="none">
                  <button class="actions-menu__item" type="button" role="menuitem" (click)="onViewClient(project.id)">Visualizacao cliente</button>
                </li>
                <li role="none">
                  <button class="actions-menu__item" type="button" role="menuitem" (click)="onCloneProject(project.id)">Clonar</button>
                </li>
                <li role="none">
                  <button class="actions-menu__item actions-menu__item--danger" type="button" role="menuitem" (click)="onDeleteProject(project.id)">Excluir</button>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section *ngIf="!loading && !error && !projects.length" class="sg-empty-state" aria-live="polite">
    <h3>Nenhum projeto cadastrado</h3>
    <p>Comece criando um novo projeto e configure seus dados de orcamento.</p>
    <ds-button variant="primary" size="sm" (buttonClick)="onCreateProject()">Criar projeto</ds-button>
  </section>
</main>
